<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Claude Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body, #root {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #ffffff;
      color: #1a1a1a;
    }

    #root {
      display: flex;
    }

    /* ── Sidebar ── */
    .sidebar {
      width: 280px;
      min-width: 280px;
      background: #f8f9fa;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
    }

    .new-chat-btn {
      width: 100%;
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px dashed #d1d5db;
      background: #ffffff;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.15s;
    }
    .new-chat-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    .session-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .session-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      color: #374151;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.15s;
    }
    .session-item:hover { background: #e5e7eb; }
    .session-item.active {
      background: #dbeafe;
      color: #1e40af;
      font-weight: 500;
    }

    .session-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    .session-status {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .session-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #d1d5db;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .session-delete {
      opacity: 0;
      border: none;
      background: none;
      color: #ef4444;
      font-size: 16px;
      cursor: pointer;
      padding: 0 4px;
      flex-shrink: 0;
    }
    .session-item:hover .session-delete { opacity: 0.6; }
    .session-delete:hover { opacity: 1 !important; }

    /* ── Main area ── */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      height: 100%;
    }

    header {
      padding: 14px 24px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      font-size: 16px;
      font-weight: 600;
      color: #c45a32;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .header-session-name {
      color: #9ca3af;
      font-weight: 400;
      font-size: 13px;
    }

    /* ── Chat area ── */
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: #ffffff;
    }

    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      font-size: 15px;
      flex-direction: column;
      gap: 8px;
    }
    .empty-state .big { font-size: 40px; margin-bottom: 8px; color: #d1d5db; }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 14px;
    }

    .message.user {
      align-self: flex-end;
      background: #2563eb;
      color: #ffffff;
      border-bottom-right-radius: 4px;
    }

    .message.assistant {
      align-self: flex-start;
      background: #f3f4f6;
      color: #1a1a1a;
      border-bottom-left-radius: 4px;
      border: 1px solid #e5e7eb;
    }

    .message.error {
      align-self: flex-start;
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .thinking {
      align-self: flex-start;
      padding: 12px 16px;
      color: #9ca3af;
      font-style: italic;
      font-size: 14px;
    }
    .thinking .dots::after {
      content: "";
      animation: dots 1.4s steps(4, end) infinite;
    }
    @keyframes dots {
      0%   { content: ""; }
      25%  { content: "."; }
      50%  { content: ".."; }
      75%  { content: "..."; }
    }

    /* ── Input area ── */
    #input-area {
      padding: 16px 24px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      flex-shrink: 0;
    }

    #prompt {
      flex: 1;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #1a1a1a;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
      min-height: 48px;
      max-height: 160px;
      transition: border-color 0.15s;
    }
    #prompt::placeholder { color: #9ca3af; }
    #prompt:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

    #send {
      padding: 0 24px;
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    #send:hover { background: #1d4ed8; }
    #send:disabled { background: #93c5fd; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    function App() {
      const [sessions, setSessions] = useState([]);
      const [activeSessionId, setActiveSessionId] = useState(null);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      // Per-session loading: Set of session IDs currently waiting for a response
      const [loadingSessions, setLoadingSessions] = useState(new Set());

      const chatRef = useRef(null);
      const inputRef = useRef(null);
      const localMessages = useRef(new Map());

      const isActiveLoading = loadingSessions.has(activeSessionId);

      useEffect(() => {
        if (chatRef.current) {
          chatRef.current.scrollTop = chatRef.current.scrollHeight;
        }
      }, [messages, loadingSessions]);

      useEffect(() => {
        inputRef.current?.focus();
      }, [activeSessionId]);

      const loadSessions = useCallback(async () => {
        try {
          const res = await fetch("/api/sessions");
          if (res.ok) setSessions(await res.json());
        } catch {}
      }, []);

      useEffect(() => { loadSessions(); }, [loadSessions]);

      const newChat = () => {
        // Don't cancel any in-flight requests — just switch view to a blank chat
        setActiveSessionId(null);
        setMessages([]);
        setInput("");
        setTimeout(() => inputRef.current?.focus(), 0);
      };

      const selectSession = (id) => {
        setActiveSessionId(id);
        setMessages(localMessages.current.get(id) || []);
        inputRef.current?.focus();
      };

      const deleteSession = async (e, id) => {
        e.stopPropagation();
        await fetch(`/api/sessions/${id}`, { method: "DELETE" });
        localMessages.current.delete(id);
        setLoadingSessions((prev) => { const next = new Set(prev); next.delete(id); return next; });
        if (activeSessionId === id) newChat();
        loadSessions();
      };

      const addLoading = (id) => setLoadingSessions((prev) => new Set(prev).add(id));
      const removeLoading = (id) => setLoadingSessions((prev) => {
        const next = new Set(prev);
        next.delete(id);
        return next;
      });

      // Ref to track latest activeSessionId inside async closures
      const activeSessionRef = useRef(activeSessionId);
      activeSessionRef.current = activeSessionId;

      const send = async () => {
        const prompt = input.trim();
        if (!prompt || isActiveLoading) return;

        setInput("");

        let sendingSessionId = activeSessionId;
        const isNew = !sendingSessionId;

        // If new chat, pre-create session immediately so it appears in sidebar
        if (isNew) {
          const tempId = crypto.randomUUID();
          sendingSessionId = tempId;

          // Pre-create on server
          fetch("/api/sessions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: tempId, name: prompt.length > 50 ? prompt.slice(0, 50) + "..." : prompt }),
          }).then(() => loadSessions());

          // Immediately show in sidebar
          setSessions((prev) => [
            { id: tempId, name: prompt.length > 50 ? prompt.slice(0, 50) + "..." : prompt, createdAt: Date.now(), messageCount: 1 },
            ...prev,
          ]);
          setActiveSessionId(tempId);
        }

        const userMsg = { role: "user", content: prompt };
        const newMessages = isNew ? [userMsg] : [...messages, userMsg];
        setMessages(newMessages);
        localMessages.current.set(sendingSessionId, newMessages);

        addLoading(sendingSessionId);

        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt, sessionId: sendingSessionId }),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({ error: res.statusText }));
            throw new Error(err.error || "Request failed");
          }

          const data = await res.json();
          const assistantMsg = { role: "assistant", content: data.result };
          const currentMsgs = localMessages.current.get(sendingSessionId) || newMessages;
          const updated = [...currentMsgs, assistantMsg];

          // Handle session ID migration from claude
          let finalId = sendingSessionId;
          if (data.sessionId && data.sessionId !== sendingSessionId) {
            finalId = data.sessionId;
            localMessages.current.delete(sendingSessionId);
            localMessages.current.set(finalId, updated);
            // Update active view if user is still on the old ID
            if (activeSessionRef.current === sendingSessionId) {
              setActiveSessionId(finalId);
              setMessages(updated);
            }
          } else {
            localMessages.current.set(sendingSessionId, updated);
            if (activeSessionRef.current === sendingSessionId) {
              setMessages(updated);
            }
          }

          loadSessions();
        } catch (e) {
          const errMsg = { role: "error", content: e.message };
          const currentMsgs = localMessages.current.get(sendingSessionId) || newMessages;
          const updated = [...currentMsgs, errMsg];
          localMessages.current.set(sendingSessionId, updated);
          if (activeSessionRef.current === sendingSessionId) {
            setMessages(updated);
          }
        } finally {
          removeLoading(sendingSessionId);
          if (activeSessionRef.current === sendingSessionId) {
            inputRef.current?.focus();
          }
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      };

      const activeSession = sessions.find((s) => s.id === activeSessionId);

      return (
        <>
          <div className="sidebar">
            <div className="sidebar-header">
              <button className="new-chat-btn" onClick={newChat}>
                + New Chat
              </button>
            </div>
            <div className="session-list">
              {sessions.length === 0 && (
                <div style={{ padding: "16px 12px", color: "#9ca3af", fontSize: 13 }}>
                  No conversations yet
                </div>
              )}
              {sessions.map((s) => (
                <div
                  key={s.id}
                  className={`session-item ${s.id === activeSessionId ? "active" : ""}`}
                  onClick={() => selectSession(s.id)}
                >
                  <span className="session-name">{s.id.slice(0, 8)}</span>
                  <span className="session-status">
                    {loadingSessions.has(s.id) && <span className="session-spinner" />}
                    <button
                      className="session-delete"
                      onClick={(e) => deleteSession(e, s.id)}
                      title="Delete"
                    >
                      x
                    </button>
                  </span>
                </div>
              ))}
            </div>
          </div>

          <div className="main">
            <header>
              Claude Chat
              {activeSession && (
                <span className="header-session-name">{activeSession.name}</span>
              )}
            </header>

            <div id="chat" ref={chatRef}>
              {messages.length === 0 && !isActiveLoading && (
                <div className="empty-state">
                  <div className="big">~</div>
                  <div>Start a new conversation with Claude</div>
                  <div style={{ fontSize: 12 }}>
                    Messages in a session share context.
                  </div>
                </div>
              )}
              {messages.map((msg, i) => (
                <div key={i} className={`message ${msg.role}`}>
                  {msg.content}
                </div>
              ))}
              {isActiveLoading && (
                <div className="thinking">
                  Claude is thinking<span className="dots"></span>
                </div>
              )}
            </div>

            <div id="input-area">
              <textarea
                id="prompt"
                ref={inputRef}
                rows={1}
                placeholder="Ask Claude something..."
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                disabled={isActiveLoading}
              />
              <button id="send" onClick={send} disabled={isActiveLoading || !input.trim()}>
                Send
              </button>
            </div>
          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
